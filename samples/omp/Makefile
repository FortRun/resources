# Disable all of make's built-in rules (similar to Fortran's implicit none)
MAKEFLAGS += --no-builtin-rules --no-builtin-variables

# Fortran Compiler and compiler Flags
FC := gfortran
FF := -O3 -fopenmp

# Linker and linker Flags
LD := $(FC)
LF := -fopenmp

# List of all source files
SRC_DIR := src
SRCS := $(notdir $(wildcard $(SRC_DIR)/*.f90))

# Where to seek prerequisites
VPATH := $(SRC_DIR):$(BUILD_DIR)

# List of all object files
BUILD_DIR := build
OBJS := $(addprefix $(BUILD_DIR)/, $(addsuffix .o, $(basename $(SRCS))))

# Include path (to be searched by compiler for *.mod files)
IP := $(BUILD_DIR)
FF += -I$(IP)

# Target executable
EXEC := $(BUILD_DIR)/ccd.exe

# Dependency file to be generated by `config` script using `fortdepend`
DEPFILE := Makefile.dep

.PHONY: all clean install

all: $(DEPFILE) $(EXEC)

$(EXEC): $(OBJS)
	$(LD) $(LF) -o $@ $^

$(OBJS): $(BUILD_DIR)/%.o : %.f90
	$(FC) -c $(FF) -o $@ $<
	@mv *.mod $(BUILD_DIR)/ 2>/dev/null ; true

# Rebuild all object files when this Makefile changes
$(OBJS): $(MAKEFILE_LIST)

# Create build directory if non existent (implemented as "order-only prerequisite")
$(OBJS): | $(BUILD_DIR)

$(BUILD_DIR):
	mkdir $@

# Generate fresh dependency file whenever the codebase (sources) is modified
$(DEPFILE): $(SRCS)
	./config

# Define dependencies between object files
# Note: In fortran, object files are interdependent through .mod files
# Note: .mod file is generated only when module code is compiled into object file

include $(DEPFILE)

clean: 
	rm -rf $(BUILD_DIR)
	rm -f $(DEPFILE)

install:
